# Zero Agent + Pip MCP Server - VPS Integration Configuration
#
# Use this when deploying alongside existing services on do-vps-prod
#
# Usage:
#   1. Copy to VPS: /opt/do-vps-prod/docker/droplet/
#   2. Add entries to Caddyfile (zero.rodda.xyz + pip.arcforge.au)
#   3. docker compose -f docker-compose.yml -f docker-compose.zero-agent.yml up -d

services:
  # ===========================================
  # Zero Agent Main Server (PWA + API)
  # Domain: zero.rodda.xyz
  # ===========================================
  zero-agent:
    image: ghcr.io/iamsamuelrodda/zero-agent:latest
    # Or build locally:
    # build:
    #   context: /opt/zero-agent
    #   dockerfile: Dockerfile
    container_name: zero-agent
    restart: unless-stopped
    networks:
      - frontend
    volumes:
      - zero-agent-data:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_PROVIDER=sqlite
      - DATABASE_PATH=/app/data/zero-agent.db
      - ANTHROPIC_API_KEY=${ZERO_AGENT_ANTHROPIC_KEY}
      - XERO_CLIENT_ID=${ZERO_AGENT_XERO_CLIENT_ID}
      - XERO_CLIENT_SECRET=${ZERO_AGENT_XERO_CLIENT_SECRET}
      - JWT_SECRET=${ZERO_AGENT_JWT_SECRET}
      - BASE_URL=https://${ZERO_AGENT_DOMAIN:-zero.rodda.xyz}
      - FRONTEND_URL=https://${ZERO_AGENT_DOMAIN:-zero.rodda.xyz}
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.5'
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # Pip MCP Remote Server (Claude.ai/ChatGPT)
  # Domain: pip.arcforge.au
  # ===========================================
  pip-mcp:
    image: ghcr.io/iamsamuelrodda/pip-mcp:latest
    # Or build locally:
    # build:
    #   context: /opt/zero-agent
    #   dockerfile: packages/mcp-remote-server/Dockerfile
    container_name: pip-mcp
    restart: unless-stopped
    networks:
      - frontend
    volumes:
      # Share SQLite database with main server
      - zero-agent-data:/app/data
    environment:
      - NODE_ENV=production
      - MCP_PORT=3001
      - DATABASE_PATH=/app/data/zero-agent.db
      - XERO_CLIENT_ID=${ZERO_AGENT_XERO_CLIENT_ID}
      - XERO_CLIENT_SECRET=${ZERO_AGENT_XERO_CLIENT_SECRET}
      - JWT_SECRET=${ZERO_AGENT_JWT_SECRET}
      - BASE_URL=https://${PIP_MCP_DOMAIN:-pip.arcforge.au}
    deploy:
      resources:
        limits:
          memory: 256M  # Lighter than main server (no PWA)
          cpus: '0.25'
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      zero-agent:
        condition: service_healthy

volumes:
  zero-agent-data:
    name: zero-agent-data

# Network should already exist from main docker-compose.yml
networks:
  frontend:
    external: true
